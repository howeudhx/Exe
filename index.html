<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Verification</title>
  <style>
    :root {
      --bg: #ffffff;
      --card-bg: #f9fafb; /* gray-50 */
      --text: #1f2937; /* gray-800 */
      --subtext: #6b7280; /* gray-500 */
      --border: #e5e7eb; /* gray-200 */
      --accent: #10b981; /* emerald-500 (Success) */
      --warn: #f59e0b; /* amber-500 (Warning) */
      --error: #ef4444; /* red-500 (Error) */
    }

    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans Thai", sans-serif;
      line-height: 1.5;
      margin: 0;
    }

    .container {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    .card {
      width: 100%;
      max-width: 480px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      padding: 24px;
    }

    .header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    /* ปรับแต่งสำหรับ Logo ที่เป็น Image */
    .logo {
      width: 24px; 
      height: 24px;
      border-radius: 4px;
      margin-right: 12px;
      /* ลบ background และ color เดิมออก */
    }
    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain; /* ปรับให้ภาพพอดีโดยไม่ตัด */
      border-radius: 4px;
    }

    .title {
      font-weight: 600;
      font-size: 18px;
    }

    .subtitle {
      color: var(--subtext);
      font-size: 14px;
      margin-top: 4px;
    }

    .list {
      display: grid;
      gap: 12px;
    }

    .item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    .item:last-child { border-bottom: none; }

    .info {
      display: flex;
      align-items: center;
      flex-grow: 1;
    }

    .label {
      font-weight: 500;
      font-size: 14px;
      margin-left: 10px;
    }

    .icon {
      width: 18px; height: 18px;
      border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      font-size: 10px;
      flex-shrink: 0;
    }
    
    .icon.spin {
      border: 2px solid var(--border);
      border-top-color: var(--subtext);
      animation: spin 0.8s linear infinite;
    }

    .icon.ok { background: var(--accent); color: white; }
    .icon.warn { background: var(--warn); color: white; }
    .icon.err { background: var(--error); color: white; }

    @keyframes spin { to { transform: rotate(360deg); } }

    .status-pill {
      font-size: 12px;
      font-weight: 500;
      color: var(--subtext);
      text-align: right;
    }

    .overall {
      margin-top: 20px;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      opacity: 0; transform: translateY(6px);
      transition: 240ms ease;
    }
    .overall.show { opacity: 1; transform: translateY(0); }

    .overall.ok { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; } 
    .overall.warn { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; } 
    .overall.err { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; } 

    /* Mobile specific adjustments (Minimalism) */
    @media (max-width: 500px) {
        .card { padding: 16px; border-radius: 8px; }
        .title { font-size: 16px; }
        .subtitle { font-size: 12px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" role="status" aria-live="polite">
      <div class="header">
        <div class="logo">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTcf7HvoaWiE40ApWMegftFVg9L6E_ltFF5qBDV2DdsZA&s=10" alt="Logo" />
        </div>
        <div>
          <div class="title" id="main-title">Verifying...</div>
          <div class="subtitle">กำลังตรวจสอบความปลอดภัยและเสถียรภาพการเชื่อมต่อ</div>
        </div>
      </div>

      <div class="list" id="checks">
        <div class="item" id="stability-item">
          <div class="info">
            <div class="icon spin" id="stability-icon"></div>
            <div class="label">Internet Stability</div>
          </div>
          <div class="status-pill" id="stability-pill">...</div>
        </div>

        <div class="item" id="malware-item">
          <div class="info">
            <div class="icon spin" id="malware-icon"></div>
            <div class="label">Security & URL Check</div>
          </div>
          <div class="status-pill" id="malware-pill">...</div>
        </div>

        <div class="item" id="ip-item">
          <div class="info">
            <div class="icon spin" id="ip-icon"></div>
            <div class="label">Public IP</div>
          </div>
          <div class="status-pill" id="ip-pill">...</div>
        </div>
        
        <div class="item" id="bot-item">
          <div class="info">
            <div class="icon spin" id="bot-icon"></div>
            <div class="label">Bot Detection</div>
          </div>
          <div class="status-pill" id="bot-pill">...</div>
        </div>
      </div>

      <div class="overall" id="overall">Verification Complete</div>
    </div>
  </div>

  <script>
    // --- UI Helpers ---
    function setOK(id, pillText){
      const icon = document.getElementById(id + '-icon');
      const pill = document.getElementById(id + '-pill');
      icon.className = 'icon ok';
      icon.textContent = '✓';
      pill.textContent = pillText;
    }
    function setWarn(id, pillText){
      const icon = document.getElementById(id + '-icon');
      const pill = document.getElementById(id + '-pill');
      icon.className = 'icon warn';
      icon.textContent = '!';
      pill.textContent = pillText;
    }
    function setErr(id, pillText){
      const icon = document.getElementById(id + '-icon');
      const pill = document.getElementById(id + '-pill');
      icon.className = 'icon err';
      icon.textContent = '×';
      pill.textContent = pillText;
    }

    // --- Core Checks Configuration ---
    const DEFAULT_TIMEOUT = 5000;
    const TARGET_DOMAIN = 'krnl.cat'; // โดเมนเป้าหมายที่ควรจะเป็น
    const CURRENT_URL = window.location.hostname; 

    // Helper function สำหรับ Fetch ที่มี Timeout
    async function fetchWithTimeout(url, options = {}, timeout = DEFAULT_TIMEOUT) {
        const ctrl = new AbortController();
        const timer = setTimeout(() => ctrl.abort(), timeout);
        
        try {
            const res = await fetch(url, { signal: ctrl.signal, ...options });
            clearTimeout(timer);
            return res;
        } catch (e) {
            clearTimeout(timer);
            throw e; 
        }
    }

    // --- 1. Internet Stability Check (Ping Simulation) ---
    async function checkStability(){
        const TEST_URL = 'https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png';
        const ITERATIONS = 3;
        let totalLatency = 0;
        let successCount = 0;

        try {
            for (let i = 0; i < ITERATIONS; i++) {
                const startTime = performance.now();
                await fetchWithTimeout(TEST_URL, { mode:'no-cors', cache: 'reload' }, 4000);
                const endTime = performance.now();
                totalLatency += (endTime - startTime);
                successCount++;
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            const avgLatency = totalLatency / successCount;
            
            if (successCount === 0) {
                 setWarn('stability', 'Offline/No connection');
                 return true; 
            } else if (avgLatency > 1500 || successCount < ITERATIONS) {
                 setWarn('stability', `Unstable (${avgLatency.toFixed(0)} ms)`);
                 return true; 
            } else {
                setOK('stability', `Stable (${avgLatency.toFixed(0)} ms)`);
                return true;
            }
        } catch (e) {
            setWarn('stability', 'Timeout/Blocked');
            return true; 
        }
    }

    // --- 2. Security & URL Check (HTTPS และ Redirect Logic) ---
    async function checkMalware(){
        const isSecureContext = window.isSecureContext;
        let status = true;
        let messages = [];
        
        await new Promise(resolve => setTimeout(resolve, 1500)); 

        // 1. ตรวจสอบ HTTPS
        if (!isSecureContext) {
            messages.push('Insecure (No HTTPS)');
            status = false; 
        }
        
        // 2. ตรวจสอบ URL Redirect (จำลอง)
        const currentDomain = CURRENT_URL.replace(/^www\./, '');
        if (currentDomain !== TARGET_DOMAIN && currentDomain !== '') {
            messages.push(`Redirected to ${currentDomain}`);
            // ถ้าโดเมนไม่ตรง และไม่ใช่ localhost/empty string ให้ Block
            setErr('malware', messages.join(' / '));
            return false; // **Block ทันที**
        } 
        
        if (!status) {
            setWarn('malware', messages.join(' / ') + ' - OK');
            return true; // **ถ้าแค่ Insecure แต่ URL ตรง ถือว่าผ่าน (มี Warning)**
        }
        
        setOK('malware', 'Secure Context & URL Matched');
        return true;
    }


    // --- 3. Public IP Check ---
    async function checkIP(){
      try {
        const res = await fetchWithTimeout('https://api.ipify.org?format=json');
        if(!res.ok) throw new Error('ipify failed');
        const data = await res.json();
        setOK('ip', data.ip ?? 'Found');
        return true;
      } catch (e) {
        setWarn('ip', 'Not Found');
        return true; 
      }
    }

    // --- 4. Bot Detection (Integration of BotDetector) ---
    // (***โค้ด BotDetector ที่ท่านให้มา***)
    function BotDetector(args) { /* ... (โค้ด BotDetector เดิม) ... */
        var self = this;
        self.isBot = false;
        self.tests = {};

        var selectedTests = args.tests || [];
        if (selectedTests.length == 0 || selectedTests.indexOf(BotDetector.Tests.SCROLL) != -1) {
                self.tests[BotDetector.Tests.SCROLL] = function() {
                        var e = function() {
                                self.tests[BotDetector.Tests.SCROLL] = true;
                                self.update()
                                self.unbindEvent(window, BotDetector.Tests.SCROLL, e)
                                self.unbindEvent(document, BotDetector.Tests.SCROLL, e)
                        };
                        self.bindEvent(window, BotDetector.Tests.SCROLL, e);
                        self.bindEvent(document, BotDetector.Tests.SCROLL, e);
                };
        }
        if (selectedTests.length == 0 || selectedTests.indexOf(BotDetector.Tests.MOUSE) != -1) {
                self.tests[BotDetector.Tests.MOUSE] = function() {
                        var e = function() {
                                self.tests[BotDetector.Tests.MOUSE] = true;
                                self.update();
                                self.unbindEvent(window, BotDetector.Tests.MOUSE, e);
                        }
                        self.bindEvent(window, BotDetector.Tests.MOUSE, e);
                };
        }
        if (selectedTests.length == 0 || selectedTests.indexOf(BotDetector.Tests.KEYUP) != -1) {
                self.tests[BotDetector.Tests.KEYUP] = function() {
                        var e = function() {
                                self.tests[BotDetector.Tests.KEYUP] = true;
                                self.update();
                                self.unbindEvent(window, BotDetector.Tests.KEYUP, e);
                        }
                        self.bindEvent(window, BotDetector.Tests.KEYUP, e);
                };        
        }        
        if (selectedTests.length == 0 || selectedTests.indexOf(BotDetector.Tests.SWIPE) != -1) {
                self.tests[BotDetector.Tests.SWIPE_TOUCHSTART] = function() {
                        var e = function() {
                                self.tests[BotDetector.Tests.SWIPE_TOUCHSTART] = true;
                                self.update();
                                self.unbindEvent(document, BotDetector.Tests.SWIPE_TOUCHSTART);
                        }
                        self.bindEvent(document, BotDetector.Tests.SWIPE_TOUCHSTART);
                }
        }
        if (selectedTests.length == 0 || selectedTests.indexOf(BotDetector.Tests.DEVICE_MOTION) != -1) {
                self.tests[BotDetector.Tests.DEVICE_MOTION] = function() {
                        var e = function(event) {
                                if(event.rotationRate.alpha || event.rotationRate.beta || event.rotationRate.gamma) {
                                        var userAgent = navigator.userAgent.toLowerCase();
                                        var isAndroid = userAgent.indexOf('android') != -1;
                                        var beta = isAndroid ? event.rotationRate.beta : Math.round(event.rotationRate.beta / 10) * 10;
                                        var gamma = isAndroid ? event.rotationRate.gamma : Math.round(event.rotationRate.gamma / 10) * 10;
                                        if (!self.lastRotationData) {
                                                self.lastRotationData = {
                                                        beta: beta,
                                                        gamma: gamma
                                                };
                                        }
                                        else {
                                                var movement = beta != self.lastRotationData.beta || gamma != self.lastRotationData.gamma;
                                                if (isAndroid) {
                                                        movement = movement && (beta > 0.2 || gamma > 0.2);
                                                }
                                                var args = { beta: beta, gamma: gamma }
                                                self.tests[BotDetector.Tests.DEVICE_MOTION] = movement;
                                                self.update();
                                                if (movement) {
                                                        self.unbindEvent(window, BotDetector.Tests.DEVICE_MOTION, e);                
                                                }
                                        }
                                }
                                else {
                                        self.tests[BotDetector.Tests.DEVICE_MOTION] = false;
                                }

                        }
                        self.bindEvent(window, BotDetector.Tests.DEVICE_MOTION, e);
                }
        }
        if (selectedTests.length == 0 || selectedTests.indexOf(BotDetector.Tests.DEVICE_ORIENTATION) != -1) {
                self.tests[BotDetector.Tests.DEVICE_ORIENTATION] = function() {
                        var e = function() {
                                self.tests[BotDetector.Tests.DEVICE_ORIENTATION] = true;
                                self.update();
                                self.unbindEvent(window, BotDetector.Tests.DEVICE_ORIENTATION, e);
                        }
                        self.bindEvent(window, BotDetector.Tests.DEVICE_ORIENTATION);
                }
        }
        if (selectedTests.length == 0 || selectedTests.indexOf(BotDetector.Tests.DEVICE_ORIENTATION_MOZ) != -1) {
                self.tests[BotDetector.Tests.DEVICE_ORIENTATION_MOZ] = function() {
                        var e = function() {
                                self.tests[BotDetector.Tests.DEVICE_ORIENTATION_MOZ] = true;
                                self.update();
                                self.unbindEvent(window, BotDetector.Tests.DEVICE_ORIENTATION_MOZ);
                        }
                        self.bindEvent(window, BotDetector.Tests.DEVICE_ORIENTATION_MOZ);
                }
        }


        self.cases = {};
        self.timeout = args.timeout || 1000;
        self.callback = args.callback || null;
        self.detected = false;
    }

    BotDetector.Tests = {
            KEYUP: 'keyup',
            MOUSE: 'mousemove',
            SWIPE: 'swipe',
            SWIPE_TOUCHSTART: 'touchstart',
            SWIPE_TOUCHMOVE: 'touchmove',
            SWIPE_TOUCHEND: 'touchend',
            SCROLL: 'scroll',
            GESTURE: 'gesture',
            GYROSCOPE: 'gyroscope',
            DEVICE_MOTION: 'devicemotion',
            DEVICE_ORIENTATION: 'deviceorientation',
            DEVICE_ORIENTATION_MOZ: 'MozOrientation'
    };
    BotDetector.prototype.update = function(notify) {
            var self = this;
            var count = 0;
            var tests = 0;
            for(var i in self.tests) {
                    if (self.tests.hasOwnProperty(i)) {
                            self.cases[i] = self.tests[i] === true;
                            if (self.cases[i] === true) {
                                    count++;
                            }
                    }
                    tests++;
            }
            self.isBot = count ==  0;
            self.allMatched = count == tests;
            if (notify !== false) {
                    self.callback(self);
            }
    }

    BotDetector.prototype.bindEvent = function(e, type, handler) {
            if (e.addEventListener) {
                    e.addEventListener(type, handler, false);
            }
            else if(e.attachEvent) {
                    e.attachEvent("on" + type, handler);
            }
    };

    BotDetector.prototype.unbindEvent = function(e, type, handle) {
            if (e.removeEventListener) {
                    e.removeEventListener(type, handle, false);
            }
            else {
                    var evtName = "on" + type;
                    if (e.detachEvent) {
                            if (typeof e[evtName] === 'undefined') {
                                    e[type] = null
                            }
                            e.detachEvent(evtName)
                    }
            }
    };
    BotDetector.prototype.monitor = function() {
            var self = this;
            for(var i in this.tests) {
                    if (this.tests.hasOwnProperty(i)) {
                            this.tests[i].call();
                    }
            }        
            this.update(false);
            setTimeout(function() {
                    self.update(true);
            }, self.timeout);
    };

    function checkBot(){
        return new Promise((resolve) => {
            const botDetector = new BotDetector({
                timeout: 3000, 
                callback: function(result) {
                    if (result.isBot) {
                        // **ปรับแก้: ถ้าไม่มีการเคลื่อนไหวเลย (isBot=true) ให้เป็น Warning แทน Error**
                        setWarn('bot', 'No Interaction Detected');
                        resolve(true); // อนุญาตให้ผ่าน แต่มี Warning
                    } else if (result.allMatched) {
                        setOK('bot', 'Human Confirmed');
                        resolve(true);
                    } else if (Object.keys(result.cases).some(key => result.cases[key])) {
                        setOK('bot', 'Human Confirmed');
                        resolve(true);
                    } else {
                        // กรณีที่ไม่ควรเกิดขึ้น แต่กันไว้
                        setErr('bot', 'Unknown Automation/Error');
                        resolve(false); 
                    }
                }
            });

            botDetector.monitor();
        });
    }

    // --- Run All Checks ---
    async function run(){
      // Note: checkBot ต้องรันเป็นตัวสุดท้ายเสมอ เพราะต้องรอ 3000ms
      const results = await Promise.allSettled([
        checkStability(),
        checkMalware(),
        checkIP(),
        checkBot() 
      ]);

      const stabilityOk = results[0].status === 'fulfilled' && results[0].value === true;
      const malwareOk = results[1].status === 'fulfilled' && results[1].value === true;
      const ipOk = results[2].status === 'fulfilled' && results[2].value === true;
      const botOk = results[3].status === 'fulfilled' && results[3].value === true;

      const title = document.getElementById('main-title');
      const overall = document.getElementById('overall');
      
      let overallClass = 'ok';
      let overallStatus = 'Verification Complete';

      // 1. ตรวจสอบ Error (Malware Check ที่มีการ Redirect)
      if (!malwareOk) {
        overallClass = 'err';
        overallStatus = 'SECURITY FAILURE! ACCESS DENIED.';
      } 
      // 2. ตรวจสอบ Warning (Bot No Interaction, Stability, IP)
      else {
        let hasWarning = false;

        // ตรวจสอบ Warning จาก Pill
        const checks = ['stability-pill', 'ip-pill', 'bot-pill'];
        for (const id of checks) {
          const pill = document.getElementById(id).textContent;
          if (pill.includes('Unstable') || pill.includes('Timeout') || pill.includes('Not Found') || pill.includes('No Interaction')) {
            hasWarning = true;
            break;
          }
        }

        // ตรวจสอบ Warning จาก Malware Check (Insecure Context)
        if (document.getElementById('malware-pill').textContent.includes('Insecure')) {
            hasWarning = true;
        }

        if (hasWarning) {
             overallClass = 'warn';
             overallStatus = 'Verification Complete (with warnings).';
        }
      }

      title.textContent = overallStatus;
      overall.textContent = overallStatus;
      overall.className = `overall ${overallClass} show`;
    }

    // Kick off
    run();
  </script>
</body>
</html>
